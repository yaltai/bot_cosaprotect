client.on('messageCreate', async (message) => {
    if (!message.content.startsWith(prefix) || message.author.bot) return;

    const args = message.content.slice(prefix.length).split(/ +/);
    const command = args.shift().toLowerCase();
    const wait = require('util').promisify(setTimeout);
    if (message.content.startsWith("!ticket")) {
        const open = new MessageButton()
            .setLabel("Cr√©er un ticket")
            .setCustomId("open")
            .setStyle('SUCCESS')
            .setEmoji('üì©')
            .setDisabled(false);
        const close2 = new MessageButton()
            .setLabel("Fermer")
            .setCustomId("close2")
            .setStyle("DANGER");

        const annuler = new MessageButton()
            .setLabel("Anuler")
            .setCustomId("annuler")
            .setStyle("SECONDARY");

        const close1 = new MessageButton()
            .setLabel("Fermer le ticket")
            .setCustomId("close1")
            .setStyle("DANGER")
            .setEmoji('üîí');

        const ouvrir = new MessageButton()
            .setLabel("R√©ouvrir")
            .setCustomId("ouvrir")
            .setStyle("green")
            .setEmoji('üîì')

        const fermer = new MessageButton()
            .setLabel("Supprimez")
            .setCustomId("fermer")
            .setStyle("red")
            .setEmoji('‚õî')

        const row3 = new MessageActionRow()
            .addComponents(ouvrir, fermer);

        const row2 = new MessageActionRow()
            .addComponents(close2, annuler);

            const row1 = new MessageActionRow()
            .addComponents(close1);

        const row = new MessageActionRow().addComponents(
            open
        )

        const embed = new MessageEmbed()
            .setColor("#9300FF")
            .setTitle("**Cr√©ation de Ticket**")
            .setAuthor("Marbuela", "https://cdn.discordapp.com/icons/835495895909793793/8e86be9b82a380e4b34c8048e56088bb.webp?size=128")
            .setDescription(`Une question ou un probl√®me?\nVeuillez s√©lectionnez le bouton ci-dessous.`)
            .setFooter("Marbuela „Éª 2021")
        if (message.member.permissions.has("ADMINISTRATOR")) {
            message.channel.send({ embeds: [embed], components: [row] })
        } else {
            message.channel.send({ content: 'Tu n\'as pas les permissions' })
        }

        const filter = (interaction) =>
         interaction.user.id === message.author.id &&
         interaction.user.id !== message.author.bot;

        const collector = message.channel.createMessageComponentCollector({
            filter,
            type: "BUTTON",
          });

        collector.on('collect', async (interaction) => {
            if (interaction.customId === 'open') {
                const member = interaction.user.id
                const everyone = interaction.guild.roles.cache.find((r) => r.name === 'everyone')
                interaction.guild.channels.create(`ticket de ${member.username}`, {
                    type: 'text',
                    parent: "876988511310471219", // a modifier category
                    permissionOverwrites: [
                        {
                            id: member,
                            allow: ['SEND_MESSAGES', 'VIEW_CHANNEL'],
                        },
                        {
                            id: '865218439169835058', // a modifier role
                            deny: ['VIEW_CHANNEL'],
                        },
                    ],
                }).then(async ch => {
                    const embed = new MessageEmbed()
                        .setAuthor(`${interaction.user.username} | Marbuela`, "https://cdn.discordapp.com/icons/835495895909793793/8e86be9b82a380e4b34c8048e56088bb.webp?size=128")
                        .setDescription('Nous te demandons d\'expliquer ta requ√™te de la mani√®re la plus pr√©cise possible afin que le staff t\'aide le plus vite possible. Merci d\'avance')
                        .setFooter('Pour fermer le ticket merci de cliquer sur le bouton ci dessous. ‚¨áÔ∏è')

                    await ch.send({ embeds: [embed], components: [row1] })

                })
                interaction.reply({content : 'Salon cr√©e'}).then(async(interaction) => {
                    collector.on('collect', async (interaction) => {
                        if (row1.components.find((r) => r.customId  === 'close1')) {
                            interaction.reply({ content: 'Es-tu s√ªr de vouloir fermer le ticket ?', components: [row2] })
                        } else if (row2.components.find((r) => r.customId  === 'close2')) {
                            const member = interaction.user.id
                            interaction.channel.edit({
                                permissionOverwrites: [
                                    {
                                        id: member,
                                        deny: ['SEND_MESSAGES', 'VIEW_CHANNEL'],
                                    },
                                    {
                                        id: '865218439169835058', // a modifier role
                                        deny: ['VIEW_CHANNEL'],
                                    },
                                ],
                            })
                            const embed = new MessageEmbed()
                                .setAuthor(member, member.displayAvatarURL())
                                .setDescription(`Ticket ferm√© par **${member}**`)
                                .setColor('#9300FF')
                                .setTimestamp()
                            interaction.reply({embeds : [embed], components : [row3]})
                        } else if (interaction.customId === 'annuler') {
                            interaction.delete()
                        } else if (interaction.CustomId === 'ouvrir') {
                            const member = interaction.user.id
                            interaction.channel.edit({
                                permissionOverwrites: [
                                    {
                                        id: member,
                                        allow: ['SEND_MESSAGES', 'VIEW_CHANNEL'],
                                    },
                                    {
                                        id: '865218439169835058', // a modifier role
                                        deny: ['VIEW_CHANNEL'],
                                    },
                                ],
                            })
                            interaction.delete()
                        } else if (interaction.customId === 'fermer') {
                            interaction.delete()
                    }})

                })
            } else return
        })
    }
})